<template>

  <div class="container">
    <div class="mainpage-title">
      <blockquote class="mainpage-profile">
        <b> <p>ONLINE AI INTERVIEW REPORT</p></b>
      </blockquote>

    </div>
    <div class="mains-header-container">
      <div class="mains-headers-left">
        <div class="mains-headers-lefts">
          <div
            style="display: flex; justify-content: center; align-items: center"
          >
            <img
              :src="profileImageUrl"
              class="center-img"
              alt="Profile Image"
              @error="handleImageError"
            />
          </div>
          <div>
            <p class="mains-headers-p">{{ memberData.name }}</p>
          </div>
          <div>
            <table class="mains-headers-table">
              <tr>
                <td class="mains-headers-td">ÏßÄÏõêÎ∂ÑÏïº</td>
                <td class="mains-headers-td-a">{{ memberData.categcd }}</td>
              </tr>
              <tr>
                <td class="mains-headers-td">Ìï∏ Îìú Ìè∞</td>
                <td class="mains-headers-td-a">{{ memberData.phonenum }}</td>
              </tr>
              <tr>
                <td class="mains-headers-td">Ïù¥ Î©î Ïùº</td>
                <td class="mains-headers-td-a">{{ memberData.email }}</td>
              </tr>
              <tr>
                <td class="mains-headers-td">Í±∞Ï£ºÏßÄÏó≠</td>
                <td class="mains-headers-td-a">{{ memberData.loccd }}</td>
              </tr>
            </table>
          </div>
        </div>
        <div class="mains-headers-middle">
          <div class="mains-headers-middle-top">
            <div class="analysis-head">Î∂ÑÏÑù Í≤∞Í≥º</div>
            <div style="display: flex">
              <div>
                <div class="analysis-left">
                  Ïä§Ìä∏Î†àÏä§
                  <div class="progress-container">
                    <div class="progress-bar" :data-value="stressRate"></div>
                  </div>
                  <div class="analysis-rate">{{ stressRate }}%</div>
                </div>
                <div class="analysis-left">
                  ÏùåÏÑ±Î∂ÑÏÑù
                  <div class="progress-container">
                    <div class="progress-bar" :data-value="voiceRate"></div>
                  </div>
                  <div class="analysis-rate">{{ voiceRate }}%</div>
                </div>
                <div class="analysis-left">
                  ÏûêÏÑ∏Î∂ÑÏÑù
                  <div class="progress-container">
                    <div
                      class="progress-bar"
                      :data-value="postureBadCountRate"
                    ></div>
                  </div>
                  <div class="analysis-rate">{{ postureBadCountRate }}%</div>
                </div>
                <div class="analysis-left">
                  Ïª®ÏÑ§ÌÑ¥Ìä∏ ÌèâÍ∞Ä
                  <div class="progress-container" style="margin-left: 8.5px">
                    <div
                      class="progress-bar"
                      :data-value="interviewReport.cnsscore"
                    ></div>
                  </div>
                  <div class="analysis-rate">
                    {{ interviewReport.cnsscore }}Ï†ê
                  </div>
                </div>
              </div>
            </div>
          </div>
          <!-- ÌïµÏã¨ ÌÇ§ÏõåÎìú Î∂ÄÎ∂Ñ -->
          <div class="mains-headers-middle-bottom">
            <div>
              <div class="mains-result-head">ÌïµÏã¨ ÌÇ§ÏõåÎìú</div>
              <div style="margin-left: 30px; margin-top: 10px">
                <div style="display: flex; margin-bottom: 25px">
                  <div style="display: flex">
                    <img src="img/res_stress.png" class="res-img" />
                    <p class="res-text">{{ keywordStressLevel }}</p>
                  </div>
                  <div style="display: flex; margin-left: 20px">
                    <img src="img/ress_audio.png" class="res-img" />
                    <p class="res-text">{{ keywordVoiceStability }}</p>
                  </div>
                </div>
                <div style="display: flex">
                  <div style="display: flex">
                    <img src="img/res_po.png" class="res-img" />
                    <p class="res-text">{{ keywordPostureBalance }}</p>
                  </div>
                  <div style="display: flex; margin-left: 20px">
                    <img src="img/res_resume.png" class="res-img" />
                    <p class="res-text">{{ keywordConsultantMsg }}</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="mains-headers-right">
          <div class="mains-headers-right-top">
            <div class="mains-result-head">Dates to Remember</div>
            <div style="margin-left: 20px; margin-top: 10px; font-size: 1.1rem">
              <div
                v-for="schedule in upcomingSchedules"
                :key="schedule.schno"
                style="display: flex; margin-bottom: 15px; align-items: center"
              >
                <div
                  style="
                    width: 60px;
                    text-align: center;
                    font-weight: bold;
                    color: #007bff;
                    margin-left: 5px;
                  "
                >
                  D-{{ schedule.dday }}
                </div>
                <div>
                  <div style="font-weight: bold; margin-left: 20px">
                    {{ schedule.title }}
                    <span
                      style="
                        font-size: 0.9em;
                        color: #6c757d;
                        margin-left: 30px;
                      "
                      >{{ schedule.content }}</span
                    >
                  </div>
                </div>
              </div>
            </div>
          </div>
          <!-- Ïª®ÏÑ§ÌÑ¥Ìä∏ Ï†ïÎ≥¥ -->
          <div class="mains-headers-right-bottom">
            <div class="main-con-head">My Consultant</div>
            <div
              v-if="consultantDetail && consultantDetail.consultant"
              style="
                display: flex;
                align-items: center;
                justify-content: space-evenly;
              "
            >
              <img
                :src="ConsultantImageUrl"
                class="center-img2"
                alt="Consultant Image"
                @error="handleImageError"
              />
              <div class="main-con-name" @click="goToConsultantChat">
                {{ consultantDetail.consultant.name }} Ïª®ÏÑ§ÌÑ¥Ìä∏
                <div class="chat">‚ûï</div>
                <p
                  style="
                    width: 100px;
                    position: absolute;
                    margin-left: -30px;
                    margin-top: -14px;
                    font-size: 1.9rem;
                  "
                >
                  ü™™
                </p>
                <p style="font-size: 0.8em; color: #6c757d; margin-left: 40px">
                  {{ consultantDetail.consultant.categcd }} Ï†ÑÎ¨∏
                </p>
              </div>
            </div>
            <div v-else>
              <button @click="goToConsultantInfo" class="apply-button">
                Ïª®ÏÑ§ÌÑ¥Ìä∏ Ïã†Ï≤≠ÌïòÎü¨ Í∞ÄÍ∏∞
              </button>
            </div>
          </div>
          <!-- Ïª®ÏÑ§ÌÑ¥Ìä∏ Ï†ïÎ≥¥ -->
        </div>
      </div>
    </div>
    <div>
      <div style="display: flex; gap: 20px" class="mains-tap">
        <div @click="activateSection('ai-analysis', $event)">AIÏ¢ÖÌï©Î∂ÑÏÑù</div>
        <div @click="activateSection('consulting', $event)">Ïª®ÏÑ§ÌåÖ</div>
      </div>
      <div class="mains-header"></div>
    </div>

    <!-- AIÏ¢ÖÌï©Î∂ÑÏÑùÌÉ≠ -->
    <div
      id="ai-analysis"
      class="tab-content"
      v-if="activeSection === 'ai-analysis'"
    >
      <div class="mains-content">
        <div class="mains-floor-1">
          <div class="box2">
            <p class="box-text">Í∞êÏ†ï Î∂ÑÏÑù Í≤∞Í≥º</p>
            <div id="chart-1" style="margin-top: -10px"></div>
          </div>
          <div class="box5">
            <p class="box-text">ÏùåÏÑ± Î∂ÑÏÑù Í≤∞Í≥º</p>
            <div id="chart-2" style="margin-top: -15px"></div>
          </div>
        </div>
        <div class="mains-floor-2">
          <div class="box3">
            <p class="box-text">ÏûêÏÑ∏ Î∂ÑÏÑù Í≤∞Í≥º</p>
            <div id="chart-3" style="margin-top: -10px"></div>
          </div>
          <div class="box6">
            <p class="box-text">Í∞êÏÑ±, ÏùåÏÑ±, ÏûêÏÑ∏ ÏöîÏïΩ</p>
            <div id="chart-4" style="margin-top: -10px"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Ïª®ÏÑ§ÌåÖ ÌÉ≠ -->
    <div
      id="consulting"
      class="tab-content"
      v-if="activeSection === 'consulting'"
    >
      <div
        class="mains-content"
        style="
          display: flex;
          gap: 20px;
          align-items: center;
          justify-content: space-evenly;
        "
      >
        <div>
          <!-- ÏßÅÎ¨¥Î©¥Ï†ë 1Î≤à -->
          <div class="box10-2">
            <div class="question-container">
              <p class="box-text3">ÏßÅÎ¨¥Î©¥Ï†ë 1Î≤à</p>
              <p class="interview-q">
                {{ interviewReport.jobquestion1 || "ÏßàÎ¨∏ ÏóÜÏùå" }}
              </p>
            </div>
            <div class="answer-container">
              <p class="box-text2">ÎÇòÏùò ÎãµÎ≥Ä</p>
              <p class="interview-a">
                {{ interviewReport.jobanswer1 || "ÎãµÎ≥Ä ÏóÜÏùå" }}
              </p>
            </div>
          </div>

          <!-- ÏßÅÎ¨¥Î©¥Ï†ë 2Î≤à -->
          <div class="box10-2">
            <div class="question-container">
              <p class="box-text3">ÏßÅÎ¨¥Î©¥Ï†ë 2Î≤à</p>
              <p class="interview-q">
                {{ interviewReport.jobquestion2 || "ÏßàÎ¨∏ ÏóÜÏùå" }}
              </p>
            </div>
            <div class="answer-container">
              <p class="box-text2">ÎÇòÏùò ÎãµÎ≥Ä</p>
              <p class="interview-a">
                {{ interviewReport.jobanswer2 || "ÎãµÎ≥Ä ÏóÜÏùå" }}
              </p>
            </div>
          </div>
        </div>

        <div>
          <!-- ÌîºÎìúÎ∞± 1 -->
          <div class="box10-2">
            <div class="question-container">
              <p class="box-text3">Ïª®ÏÑ§ÌÑ¥Ìä∏ ÌîºÎìúÎ∞±</p>
              <hr class="box-line" />
              <p class="interview-f">
                {{ consultantfeedback.feedback1 || "ÌîºÎìúÎ∞± ÏóÜÏùå" }}
              </p>
            </div>
          </div>
          <!-- ÌîºÎìúÎ∞± 2 -->
          <div class="box10-2">
            <div class="question-container">
              <p class="box-text3">Ïª®ÏÑ§ÌÑ¥Ìä∏ ÌîºÎìúÎ∞±</p>
              <hr class="box-line" />
              <p class="interview-f">
                {{ consultantfeedback.feedback2 || "ÌîºÎìúÎ∞± ÏóÜÏùå" }}
              </p>
            </div>
          </div>
        </div>
      </div>

      <!-- ÏßÅÎ¨¥Î©¥Ï†ë Ï¢ÖÌï©Î∂ÑÏÑù -->
      <div class="box9-2">
        <p class="box-text">Ïª®ÏÑ§ÌÑ¥Ìä∏ ÌèâÍ∞Ä Ï¢ÖÌï© ÏöîÏïΩ</p>
        <hr class="box-line" />
        <p class="interview-a-p">
          {{ consultantTotalFeedback || "Ï¢ÖÌï© ÏöîÏïΩ ÎÇ¥Ïö© ÏóÜÏùå" }}
        </p>
      </div>
    </div>
  </div>
</template>

<script>
import { ref, onMounted, computed } from "vue";
import { useRouter } from "vue-router";
import axios from "axios";
import Highcharts from "highcharts";
import HighchartsMore from "highcharts/highcharts-more";

HighchartsMore(Highcharts);

export default {
  props: {
    activeSection: String,
  },
  setup() {
    const memberData = ref({});
    const categoryMap = {
      1: "IT/Í∞úÎ∞ú",
      2: "ÍµêÏú°",
      3: "ÏòÅÏóÖ/ÎßàÏºÄÌåÖ",
      4: "Í∏∞Ìöç/Ï†ÑÎûµ",
      5: "Í≤ΩÏòÅ",
    };
    const locationMap = {
      1: "ÏÑúÏö∏",
      2: "Í≤ΩÍ∏∞ÎèÑ",
      3: "Ï∂©Ï≤≠ÎèÑ",
      4: "Ï†ÑÎùºÎèÑ",
      5: "Í≤ΩÏÉÅÎèÑ",
      6: "Í∞ïÏõêÎèÑ",
      7: "Ï†úÏ£ºÎèÑ",
    };
    const interviewReport = ref({
      jobquestion1: "",
      jobanswer1: "",
      jobquestion2: "",
      jobanswer2: "",
    });
    const stressRate = ref(0);
    const voiceRate = ref(0);
    const postureBadCountRate = ref(0);
    const memberSchedules = ref([]);
    const activeSection = ref("ai-analysis");
    const consultantfeedback = ref({
      feedback1: "",
      feedback2: "",
    });
    const consultantTotalFeedback = ref("");
    const loading = ref(false);
    const error = ref(null);
    const consultantDetail = ref(null);
    const router = useRouter();

    // Ïù¥ÎØ∏ÏßÄ Î°úÎìú Ïã§Ìå® Ïãú ÎåÄÏ≤¥ Ïù¥ÎØ∏ÏßÄ ÏÑ§Ï†ï
    const handleImageError = (event) => {
      event.target.src = "/img/MainPage_image/noimg.png";
    };

    // ÌöåÏõêÏóêÍ≤å Îß§Ïπ≠Îêú Ïª®ÏÑ§ÌÑ¥Ìä∏ ÏóÜÏùÑ Îïå, Ïª®ÏÑ§ÌÑ¥Ìä∏ Ïã†Ï≤≠ ÌéòÏù¥ÏßÄÎ°ú Ïù¥Îèô
    const goToConsultantInfo = () => {
      router.push("/ConsultantInfo");
    };

    // Ïª®ÏÑ§ÌÑ¥Ìä∏ 1ÎåÄ1 ÏÉÅÎã¥ÏúºÎ°ú Í∞ÄÍ∏∞
    const goToConsultantChat = () => {
      router.push("/OneToOne");
    };

    // ÌöåÏõê Îç∞Ïù¥ÌÑ∞ Î≥ÄÌôò Ìï®Ïàò(Ìù¨ÎßùÏßÅÎ¨¥, Í±∞Ï£ºÏßÄÏó≠)
    const transformMemberData = (data) => {
      if (data) {
        return {
          ...data,
          categcd: categoryMap[data.categcd] || "Ïïå Ïàò ÏóÜÏùå",
          loccd: locationMap[data.loccd] || "Ïïå Ïàò ÏóÜÏùå",
        };
      }
      return null;
    };

    // ÌöåÏõêÏÇ¨ÏßÑ Í∞ÄÏ†∏Ïò§Í∏∞
    const profileImageUrl = computed(() => {
      if (memberData.value && memberData.value.imgname) {
        return `/img/upimg/${memberData.value.imgname}`;
      }
      return "/img/MainPage_image/noimg.png"; // Í∏∞Î≥∏ Ïù¥ÎØ∏ÏßÄ Í≤ΩÎ°ú
    });

    // ÌöåÏõêÏ†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
    const fetchMemberData = async (memno) => {
      try {
        const response = await axios.get(
          `${process.env.VUE_APP_BACK_END_URL}/mainpage/memberDetail?memno=${memno}`
        );
        memberData.value = transformMemberData(response.data);
      } catch (error) {
        console.error("Error fetching member data:", error);
      }
    };

    // Ïä§Ìä∏Î†àÏä§Ïú®
    const fetchStressRate = async (intno, memno) => {
      try {
        const response = await axios.get(
          `${process.env.VUE_APP_BACK_END_URL}/mainpage/stressRate?intno=${intno}&memno=${memno}`
        );
        stressRate.value = response.data;
      } catch (error) {
        console.error("Error fetching stress rate:", error);
      }
    };
    // ÏùåÏÑ±Î∂ÑÏÑù
    const fetchVoiceRate = async (intno, memno) => {
      try {
        const response = await axios.get(
          `${process.env.VUE_APP_BACK_END_URL}/mainpage/voiceRate?intno=${intno}&memno=${memno}`
        );
        voiceRate.value = response.data;
      } catch (error) {
        console.error("Error fetching voice rate:", error);
      }
    };
    // ÏûêÏÑ∏Î∂ÑÏÑù
    const fetchPostureBadCountRate = async (intno, memno) => {
      try {
        const response = await axios.get(
          `${process.env.VUE_APP_BACK_END_URL}/mainpage/postureBadCountRate?intno=${intno}&memno=${memno}`
        );
        postureBadCountRate.value = response.data;
      } catch (error) {
        console.error("Error fetching posture bad count rate:", error);
      }
    };
    // Ïª®ÏÑ§ÌÑ¥Ìä∏ ÌèâÍ∞ÄÏ†êÏàò
    const fetchConsultantScore = async (intno) => {
      try {
        const response = await axios.get(
          `${process.env.VUE_APP_BACK_END_URL}/mainpage/consultantScore?intno=${intno}`
        );
        interviewReport.value = response.data;
      } catch (error) {
        console.error("Error fetching consultant score:", error);
      }
    };

    // ÌöåÏõêÏóêÍ≤å Îß§Ïπ≠Îêú Ïª®ÏÑ§ÌÑ¥Ìä∏ Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
    const fetchConsultantDetail = async (memno) => {
      try {
        const response = await axios.get(
          `${process.env.VUE_APP_BACK_END_URL}/mainpage/memberConsultantDetail?memno=${memno}`
        );
        const transformedData = transformConsultantData(
          response.data || { consultant: null }
        );
        consultantDetail.value = transformedData;
      } catch (error) {
        console.error("Error fetching consultant detail:", error);
        consultantDetail.value = { consultant: null }; // Ïò§Î•ò Î∞úÏÉù Ïãú ÏïàÏ†ÑÌïú Í∏∞Î≥∏Í∞í ÏÑ§Ï†ï
      }
    };
    // Ïª®ÏÑ§ÌÑ¥Ìä∏ ÏÇ¨ÏßÑ URL Í∞ÄÏ†∏Ïò§Í∏∞
    const ConsultantImageUrl = computed(() => {
      if (
        consultantDetail.value &&
        consultantDetail.value.consultant &&
        consultantDetail.value.consultant.imgname
      ) {
        return `/img/upimg/${consultantDetail.value.consultant.imgname}`;
      }
      return "/img/MainPage_image/noimg.png"; // Í∏∞Î≥∏ Ïù¥ÎØ∏ÏßÄ Í≤ΩÎ°ú
    });

    // Ïª®ÏÑ§ÌÑ¥Ìä∏ Îç∞Ïù¥ÌÑ∞ Î≥ÄÌôò Ìï®Ïàò(Ï†ÑÎ¨∏Î∂ÑÏïº)
    const transformConsultantData = (data) => {
      if (data && data.consultant) {
        return {
          ...data,
          consultant: {
            ...data.consultant,
            categcd: categoryMap[data.consultant.categcd] || "Ïïå Ïàò ÏóÜÏùå",
          },
        };
      }
      return data; // Î≥ÄÌôòÌï† Ïàò ÏóÜÎäî Í≤ΩÏö∞ ÏõêÎ≥∏ Îç∞Ïù¥ÌÑ∞ Î∞òÌôò
    };

    // ÌöåÏõêÏùºÏ†ï
    const fetchMemberSchedules = async (memno) => {
      try {
        const response = await axios.get(
          `${process.env.VUE_APP_BACK_END_URL}/mainpage/memberSchedules?memno=${memno}`
        );
        memberSchedules.value = response.data;
      } catch (error) {
        console.error("Error fetching member schedules:", error);
      }
    };
    // ÏßÅÎ¨¥Î©¥Ï†ë ÏßàÎ¨∏&ÎãµÎ≥Ä
    const fetchConsultantQuestions = async (intno, qnos) => {
      try {
        const response = await axios.get(
          `${
            process.env.VUE_APP_BACK_END_URL
          }/mainpage/consultantQuestions?intno=${intno}&qnos=${qnos.join(
            "&qnos="
          )}`
        );
        const data = response.data;

        // ÏßàÎ¨∏Í≥º ÎãµÎ≥Ä Îß§Ìïë
        const questionMap = {
          6: { key: "jobquestion1", answerKey: "jobanswer1" },
          7: { key: "jobquestion2", answerKey: "jobanswer2" },
        };

        data.forEach((item) => {
          if (questionMap[item.qno]) {
            interviewReport.value[questionMap[item.qno].key] = item.question;
            interviewReport.value[questionMap[item.qno].answerKey] =
              item.answer;
          }
        });
      } catch (error) {
        console.error("Error fetching consultant questions:", error);
      }
    };
    // ÏßÅÎ¨¥Î©¥Ï†ë ÏßàÎ¨∏&ÎãµÎ≥ÄÎ≥Ñ ÌîºÎìúÎ∞±
    const fetchConsultantFeedback = async (memno, cnsno, intno, qnos) => {
      try {
        const response = await axios.get(
          `${process.env.VUE_APP_BACK_END_URL}/mainpage/consultantFeedback`,
          {
            params: {
              memno,
              cnsno,
              intno,
              qnos: qnos.join(","),
            },
          }
        );
        const data = response.data;

        // ÌîºÎìúÎ∞± Îß§Ìïë
        const feedbackMap = {
          6: { key: "feedback1" },
          7: { key: "feedback2" },
        };

        data.forEach((item) => {
          if (feedbackMap[item.qno]) {
            consultantfeedback.value[feedbackMap[item.qno].key] =
              item.qcnsfeedbk;
          }
        });
      } catch (error) {
        console.error("Error fetching consultant feedback:", error);
        // ÏóêÎü¨ ÏÉÅÏÑ∏ Ï†ïÎ≥¥ Î°úÍπÖ
        if (error.response) {
          console.error("Response data:", error.response.data);
          console.error("Response status:", error.response.status);
          console.error("Response headers:", error.response.headers);
        }
      }
    };
    // Ï¢ÖÌï©ÌîºÎìúÎ∞±
    const fetchConsultantTotalFeedback = async (memno, intno) => {
      try {
        const response = await axios.get(
          `${process.env.VUE_APP_BACK_END_URL}/mainpage/consultantTotalFeedback`,
          {
            params: { memno, intno },
          }
        );
        // console.log("API response:", response.data); // ÏùëÎãµ Îç∞Ïù¥ÌÑ∞ ÌôïÏù∏
        consultantTotalFeedback.value = response.data; // ÏùëÎãµ Í∞íÏùÑ ÏßÅÏ†ë Ìï†Îãπ
      } catch (error) {
        console.error("Error fetching consultant total feedback:", error);
      }
    };

    // ÌöåÏõê ÏùºÏ†ï
    const calculateDday = (date) => {
      const today = new Date();
      const targetDate = new Date(date);
      const timeDiff = targetDate.getTime() - today.getTime();
      const dayDiff = Math.ceil(timeDiff / (1000 * 3600 * 24));
      return dayDiff;
    };

    // ÎîîÎç∞Ïù¥
    const upcomingSchedules = computed(() => {
      return memberSchedules.value
        .map((schedule) => ({
          ...schedule,
          dday: calculateDday(schedule.startdt),
        }))
        .filter((schedule) => schedule.dday >= 0)
        .sort((a, b) => a.dday - b.dday)
        .slice(0, 3); // ÏµúÎåÄ 3Í∞úÏùò ÏùºÏ†ïÎßå ÌëúÏãú
    });

    // ÌïµÏã¨ÌÇ§ÏõåÎìú Î∂ÑÏÑù
    const keywordStressLevel = computed(() => {
      return stressRate.value > 40 ? "Ïä§Ìä∏Î†àÏä§Í∞Ä ÎÜíÏùå" : "Ïä§Ìä∏Î†àÏä§ Ï†ÅÏ†ïÏàòÏ§Ä";
    });

    const keywordVoiceStability = computed(() => {
      return voiceRate.value > 70 ? "Î™©ÏÜåÎ¶¨Í∞Ä Î∂àÏïàÏ†ïÌï®" : "Î™©ÏÜåÎ¶¨Í∞Ä ÏïàÏ†ïÏ†ÅÏûÑ";
    });

    const keywordPostureBalance = computed(() => {
      return postureBadCountRate.value > 50 ? "ÏûêÏÑ∏Í∞Ä Î∂àÍ∑†ÌòïÌï®" : "Í∑†Ìòï Ïû°Ìûò";
    });

    const keywordConsultantMsg = computed(() => {
      return interviewReport.value.cnsscore > 80
        ? "Îß§Ïö∞ Ïö∞ÏàòÌï®"
        : "Í∞úÏÑ†Ïù¥ ÌïÑÏöîÌï®";
    });

    // Î≤ÑÎ∏îÏ∞®Ìä∏, Ïä§ÌîåÎùºÏù∏Ï∞®Ìä∏, Î∞îÏ∞®Ìä∏, Î©ÄÌã∞Î∞îÏ∞®Ìä∏ ÏãúÏûë
    const recentScores = ref([]);
    const fetchRecentInterviewScores = async (memno) => {
      try {
        const response = await axios.get(
          `${process.env.VUE_APP_BACK_END_URL}/mainpage/recentInterviewScores?memno=${memno}`
        );
        // console.log(response.data);
        recentScores.value = response.data;
        updateEmotionBubbleChart(recentScores.value);
        updateVoiceLineChart(recentScores.value);
        updatePostureChart(recentScores.value);
        updateMultiBarChart(recentScores.value);
      } catch (error) {
        console.error("Error fetching recent interview scores:", error);
        return null;
      }
    };

    // ÎÇ†Ïßú ÌòïÏãù Î≥ÄÌôò Ìï®Ïàò
    const formatDate = (dateString) => {
      const date = new Date(dateString);
      return `${(date.getMonth() + 1).toString().padStart(2, "0")}/${date
        .getDate()
        .toString()
        .padStart(2, "0")}`;
    };

    // Î≤ÑÎ∏îÏ∞®Ìä∏
    // ÌÅ∞ Ïõê ÏïàÏóê ÎÇ†ÏßúÎ≥ÑÎ°ú ÏßàÎ¨∏Îì§Ïù¥ Î¨∂Ïù∏ packedbubble Ï∞®Ìä∏
    const updateEmotionBubbleChart = (data) => {
      // ÎÇ†ÏßúÏôÄ Í∑∏Ïóê Ìï¥ÎãπÌïòÎäî Îç∞Ïù¥ÌÑ∞Î•º Ìï®Íªò Ï†ïÎ†¨
      const sortedDates = data.dates
        .map((date, index) => ({
          date,
          index,
        }))
        .sort((a, b) => new Date(a.date) - new Date(b.date));

      // Í∞êÏ†ï Ï†êÏàò Ï§ë ÏµúÎåÄÍ∞íÏùÑ Í≥ÑÏÇ∞
      const maxEmotionScore = Math.max(
        ...Object.values(data.questionEmotionScores)
          .flat()
          .map((item) => item.score)
      );

      // Ï†ïÎ†¨Îêú ÎÇ†ÏßúÎ•º Í∏∞Î∞òÏúºÎ°ú series ÏÉùÏÑ±
      const series = sortedDates.map(({ date, index }) => ({
        name: formatDate(date), // ÎÇ†ÏßúÎ•º ÌÅ∞ ÏõêÏùò Ïù¥Î¶ÑÏúºÎ°ú ÏÇ¨Ïö©
        data: Object.keys(data.questionEmotionScores).map(
          (question, questionIndex) => ({
            name: `Q${questionIndex + 1}`, // Q1, Q2, Q3, Q4, Q5Î°ú Ïù¥Î¶Ñ ÏÑ§Ï†ï
            value: data.questionEmotionScores[question][index].score,
            good: data.questionEmotionScores[question][index].good,
            soso: data.questionEmotionScores[question][index].soso,
            bad: data.questionEmotionScores[question][index].bad,
          })
        ),
      }));

      Highcharts.chart("chart-1", {
        chart: {
          type: "packedbubble",
          height: "65%",
        },
        title: {
          text: "",
          align: "left",
        },
        subtitle: {
          text: "ÏµúÍ∑º 5Ìöå Ïù∏ÏÑ±Î©¥Ï†ë Í∏∞Ï§Ä",
          align: "left",
        },
        tooltip: {
          useHTML: true,
          pointFormat: `<b>{point.name}</b><br/>
                    Ï†êÏàò: {point.value}<br/>
                    Good: {point.good}<br/>
                    Soso: {point.soso}<br/>
                    Bad: {point.bad}`,
        },
        plotOptions: {
          packedbubble: {
            minSize: "20%",
            maxSize: "60%",
            zMin: 0,
            zMax: maxEmotionScore, // Í∞êÏ†ï Ï†êÏàòÏùò ÏµúÎåÄÍ∞íÏùÑ Í∏∞Ï§ÄÏúºÎ°ú ÏÑ§Ï†ï
            layoutAlgorithm: {
              gravitationalConstant: 0.05,
              splitSeries: true,
              seriesInteraction: false,
              dragBetweenSeries: true,
              parentNodeLimit: true,
            },
            dataLabels: {
              enabled: true,
              format: "{point.name}",
              style: {
                color: "black",
                textOutline: "none",
                fontWeight: "normal",
              },
            },
          },
        },
        series: series,
      });
    };
    // Î≤ÑÎ∏îÏ∞®Ìä∏ ÎÅù
    // Ïä§ÌîåÎùºÏù∏Ï∞®Ìä∏ ÏãúÏûë
    const updateVoiceLineChart = (data) => {
      const sortedDates = data.dates
        .map((date, index) => ({
          date,
          index,
        }))
        .sort((a, b) => new Date(a.date) - new Date(b.date));

      const series = Object.keys(data.questionVoiceScores).map((question) => {
        return {
          name: question,
          data: sortedDates.map(
            ({ index }) => data.questionVoiceScores[question][index]
          ),
        };
      });

      Highcharts.chart("chart-2", {
        chart: {
          type: "spline",
        },
        title: {
          text: " ",
          align: "center",
        },
        subtitle: {
          text: "ÏµúÍ∑º 5Ìöå Ïù∏ÏÑ±Î©¥Ï†ë Í∏∞Ï§Ä",
          align: "left",
        },
        xAxis: {
          categories: sortedDates.map(({ date }) => formatDate(date)),
          title: {
            text: "ÎÇ†Ïßú",
          },
        },
        yAxis: {
          title: {
            text: "ÏùåÏÑ± Ï†êÏàò",
          },
          max: 100,
        },
        tooltip: {
          formatter: function () {
            return `<b>${this.series.name}</b><br/>
                ÎÇ†Ïßú: ${this.x}<br/>
                Ï†êÏàò: ${this.y}`;
          },
        },
        plotOptions: {
          spline: {
            marker: {
              enabled: true,
              radius: 4,
            },
          },
        },
        series: series,
      });
    };
    // Ïä§ÌîåÎùºÏù∏ Ï∞®Ìä∏ ÎÅù
    // Î∞îÏ∞®Ìä∏ ÏãúÏûë
    const updatePostureChart = (scores) => {
      // ÎÇ†ÏßúÎ•º Í∏∞Ï§ÄÏúºÎ°ú Îç∞Ïù¥ÌÑ∞ Ï†ïÎ†¨
      const sortedData = scores.dates
        .map((date, index) => ({
          date,
          postureScore: scores.postureScores[index],
        }))
        .sort((a, b) => new Date(a.date) - new Date(b.date));

      Highcharts.chart("chart-3", {
        chart: {
          type: "column",
        },
        title: {
          text: "",
        },
        subtitle: {
          text: "ÏµúÍ∑º 5Ìöå Ïù∏ÏÑ±Î©¥Ï†ë Í∏∞Ï§Ä",
          align: "left",
        },
        colors: ["#a0d6e1"], // Í∏∞Ï°¥ Ï∞®Ìä∏Ïùò ÏÉâÏÉÅ ÏÇ¨Ïö©
        xAxis: {
          categories: sortedData.map((item) => formatDate(item.date)),
          title: {
            text: "",
          },
        },
        yAxis: {
          title: {
            text: "ÏûêÏÑ∏ Ï†êÏàò",
          },
          max: 100,
        },
        credits: {
          enabled: false,
        },
        plotOptions: {
          column: {
            borderRadius: 5,
          },
        },
        series: [
          {
            name: "",
            showInLegend: false,
            data: sortedData.map((item) => item.postureScore),
          },
        ],
        tooltip: {
          formatter: function () {
            return `<b>${this.x}</b><br/>ÏûêÏÑ∏ Ï†êÏàò: <b>${this.y}</b>`;
          },
        },
      });
    };
    // Î∞îÏ∞®Ìä∏ ÎÅù
    // Î©ÄÌã∞Î∞îÏ∞®Ìä∏ ÏãúÏûë
    const updateMultiBarChart = (scores) => {
      // ÎÇ†ÏßúÎ•º Í∏∞Ï§ÄÏúºÎ°ú Îç∞Ïù¥ÌÑ∞ Ï†ïÎ†¨
      const sortedData = scores.dates
        .map((date, index) => ({
          date,
          stressRate: scores.stressRates[index],
          voiceScore: scores.voiceScores[index],
          postureScore: scores.postureScores[index],
        }))
        .sort((a, b) => new Date(a.date) - new Date(b.date));

      Highcharts.chart("chart-4", {
        chart: {
          type: "column",
        },
        title: {
          text: "",
        },
        subtitle: {
          text: "ÏµúÍ∑º 5Ìöå Ïù∏ÏÑ±Î©¥Ï†ë Í∏∞Ï§Ä",
          align: "left",
        },
        colors: ["#FF6F61", "#8b8be0", "#88D8B0", "#f8b77d", "#FFABAB"],
        yAxis: {
          title: {
            text: "Ï†êÏàò",
          },
          max: 100,
        },
        xAxis: {
          categories: ["Í∞êÏ†ï", "ÏùåÏÑ±", "ÏûêÏÑ∏"],
        },
        credits: {
          enabled: false,
        },
        plotOptions: {
          column: {
            borderRadius: "25%",
            dataLabels: {
              enabled: true,
              formatter: function () {
                return this.y === 0 ? "" : "";
              },
            },
          },
          series: {
            minPointLength: 3, // ÏµúÏÜå ÎßâÎåÄ Í∏∏Ïù¥ ÏÑ§Ï†ï
          },
        },
        legend: {
          align: "right",
          verticalAlign: "middle",
          layout: "vertical",
        },
        series: sortedData.map((item) => ({
          name: formatDate(item.date),
          data: [
            100 - item.stressRate, // Ïä§Ìä∏Î†àÏä§Ïú®ÏùÑ Í∞êÏ†ï Ï†êÏàòÎ°ú Î≥ÄÌôò
            item.voiceScore,
            item.postureScore,
          ],
        })),
      });
    };
    // Ï†ÑÏ≤¥ Ï∞®Ìä∏ ÎÅù

    onMounted(async () => {
      const memno = 10; // ÏòàÏãú memno Í∞í
      const intno = 10; // ÏòàÏãú intno Í∞í
      const cnsno = 1001; // ÏòàÏãú cnsno Í∞í
      await fetchMemberData(memno);
      await fetchStressRate(intno, memno);
      await fetchVoiceRate(intno, memno);
      await fetchPostureBadCountRate(intno, memno);
      await fetchConsultantScore(intno);
      await fetchMemberSchedules(memno);
      await fetchConsultantQuestions(intno, [6, 7]);
      await fetchConsultantFeedback(memno, cnsno, intno, [6, 7]);
      await fetchConsultantTotalFeedback(memno, intno);
      await fetchConsultantDetail(memno);
      await fetchRecentInterviewScores(memno);

      // ÌîÑÎ°úÍ∑∏Î†àÏä§ Î∞î Ï¥àÍ∏∞Ìôî
      const progressBars = document.querySelectorAll(".progress-bar");
      progressBars.forEach((bar) => {
        const value = bar.getAttribute("data-value");
        bar.style.width = `${value}%`;
      });
    });

    // ÌÉ≠ ÌôúÏÑ±Ìôî
    const activateSection = (sectionId, event) => {
      event.preventDefault();
      activeSection.value = sectionId;
    };

    return {
      memberData,
      interviewReport,
      stressRate,
      voiceRate,
      postureBadCountRate,
      upcomingSchedules,
      activeSection,
      activateSection,
      keywordStressLevel,
      keywordVoiceStability,
      keywordPostureBalance,
      keywordConsultantMsg,
      consultantfeedback,
      consultantTotalFeedback,
      loading,
      error,
      consultantDetail,
      handleImageError,
      goToConsultantInfo,
      goToConsultantChat,
      profileImageUrl,
      ConsultantImageUrl,
      recentScores,
    };
  },
};
</script>